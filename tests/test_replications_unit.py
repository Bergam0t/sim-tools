"""Replication unit tests

Unit testing for code related to selecting the number of replications.

Credit: Some of these tests are adapted from-
    Heather, A. Monks, T. (2025). Python DES RAP Template. GitHub.
    https://github.com/pythonhealthdatascience/rap_template_python_des.
"""

from unittest.mock import MagicMock

import numpy as np
import pandas as pd
import pytest
import scipy.stats as st

from sim_tools.output_analysis import (
    OnlineStatistics,
    ReplicationsAlgorithm,
    ReplicationTabulizer
)


@pytest.mark.parametrize("look_ahead, n, exp", [
    (100, 100, 100),
    (100, 101, 101),
    (0, 500, 0)
])
def test_klimit(look_ahead, n, exp):
    """
    Check that the _klimit() calculations are as expected.

    Parameters:
    -----------
    look_ahead: int
        Minimum additional replications to look ahead to assess stability of
        precision.
    n: int
        Number of replications that would already be completed.
    exp: int
        Expected number of replications for _klimit() to return.
    """
    # Calculate additional replications that would be required
    calc = ReplicationsAlgorithm(
        look_ahead=100, initial_replications=100)._klimit()
    # Check that this meets our expected value
    assert calc == 100, (
        f"With look_ahead {look_ahead} and n={n}, the additional " +
        f"replications required should be {exp} but _klimit() returned {calc}."
    )


@pytest.mark.parametrize("arg, value", [
    ("initial_replications", -1),
    ("initial_replications", 0.5),
    ("look_ahead", -1),
    ("look_ahead", 0.5),
    ("half_width_precision", 0)
])
def test_algorithm_invalid(arg, value):
    """
    Ensure that ReplicationsAlgorithm responds appropriately to invalid inputs.

    Parameters:
    -----------
    arg: string
        Name of input for ReplicationsAlgorithm.
    value: float
        Value of input to ReplicationsAlgorithm.
    """
    with pytest.raises(ValueError):
        ReplicationsAlgorithm(**{arg: value})


def test_algorithm_invalid_budget():
    """
    Ensure that ReplicationsAlgorithm responds appropriately when
    replication_budget is less than initial_replications.
    """
    with pytest.raises(ValueError):
        ReplicationsAlgorithm(initial_replications=10,
                              replication_budget=9)


def test_onlinestat_data():
    """
    Check that OnlineStatistics will fail if an invalid data type is provided.
    """
    with pytest.raises(ValueError):
        OnlineStatistics(data=pd.Series([9, 2, 3]))


def test_onlinestat_computations():
    """
    Feed three values into OnlineStatistics and verify mean, standard
    deviation, confidence intervals, and deviation calculations.
    """
    values = [10, 20, 30]

    # Provide three values
    stats = OnlineStatistics(data=np.array(values), alpha=0.05, observer=None)

    # Expected values
    expected_mean = np.mean(values)
    expected_std = np.std(values, ddof=1)
    expected_lci, expected_uci = st.t.interval(
        confidence=0.95,
        df=len(values)-1,
        loc=np.mean(values),
        scale=st.sem(values)
    )
    expected_dev = (expected_uci - expected_mean) / expected_mean

    # Assertions
    assert np.isclose(stats.mean, expected_mean), (
        f"Expected mean {expected_mean}, got {stats.mean}")
    assert np.isclose(stats.std, expected_std), (
        f"Expected std dev {expected_std}, got {stats.std}")
    assert np.isclose(stats.lci, expected_lci), (
        f"Expected lower confidence interval {expected_lci}, got {stats.lci}")
    assert np.isclose(stats.uci, expected_uci), (
        f"Expected upper confidence interval {expected_uci}, got {stats.uci}")
    assert np.isclose(stats.deviation, expected_dev), (
        f"Expected deviation {expected_dev}, got {stats.deviation}")


def test_tabulizer_update():
    """
    Test that update correctly appends new statistical data.
    """
    tab = ReplicationTabulizer()
    mock_results = MagicMock()
    mock_results.x_i = 10
    mock_results.mean = 5.5
    mock_results.std = 1.2
    mock_results.lci = 4.8
    mock_results.uci = 6.2
    mock_results.deviation = 0.1

    tab.update(mock_results)

    assert tab.n == 1
    assert tab.x_i == [10]
    assert tab.cumulative_mean == [5.5]
    assert tab.stdev == [1.2]
    assert tab.lower == [4.8]
    assert tab.upper == [6.2]
    assert tab.dev == [0.1]


def test_tabulizer_summary_table():
    """
    Test that summary_table returns a properly formatted DataFrame.
    """
    tab = ReplicationTabulizer()
    tab.n = 3
    tab.x_i = [10, 20, 30]
    tab.cumulative_mean = [5, 10, 15]
    tab.stdev = [1, 2, 3]
    tab.lower = [3, 8, 13]
    tab.upper = [7, 12, 17]
    tab.dev = [0.1, 0.2, 0.3]

    df = tab.summary_table()

    assert isinstance(df, pd.DataFrame)
    assert len(df) == 3
    assert df["Mean"].tolist() == [10, 20, 30]
    assert df["Cumulative Mean"].tolist() == [5, 10, 15]
    assert df["Standard Deviation"].tolist() == [1, 2, 3]
    assert df["Lower Interval"].tolist() == [3, 8, 13]
    assert df["Upper Interval"].tolist() == [7, 12, 17]
    assert df["% deviation"].tolist() == [0.1, 0.2, 0.3]
